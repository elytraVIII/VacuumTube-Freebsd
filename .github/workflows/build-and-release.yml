name: Build FreeBSD Native

permissions:
  contents: write

on:
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-freebsd:
    runs-on: ubuntu-latest
    name: Build Native FreeBSD Package
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install FPM (Packaging Tool)
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential
          sudo gem install fpm

      - name: Build Electron Assets
        # We build 'unpacked' to generate the app.asar without bundling the Linux binary
        run: npx electron-builder --linux dir --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Native FreeBSD .pkg from ASAR
        run: |
          # 1. Setup the FreeBSD directory structure
          mkdir -p fakedest/usr/local/share/vacuumtube
          mkdir -p fakedest/usr/local/bin
          mkdir -p output/

          # 2. Copy the ASAR (the heart of the app)
          cp dist/linux-unpacked/resources/app.asar fakedest/usr/local/share/vacuumtube/app.asar

          # 3. Create a universal launch script for FreeBSD
          cat << 'EOF' > fakedest/usr/local/bin/vacuumtube
          #!/bin/sh
          # Search for available native Electron versions on FreeBSD
          ELECTRON=$(which electron30 || which electron29 || which electron)
          if [ -z "$ELECTRON" ]; then
            echo "Error: Native Electron not found."
            echo "Please install it using: sudo pkg install electron30"
            exit 1
          fi
          exec "$ELECTRON" /usr/local/share/vacuumtube/app.asar "$@"
          EOF
          
          chmod +x fakedest/usr/local/bin/vacuumtube

          # 4. Use FPM to build the native FreeBSD .pkg
          # This package is tiny because it doesn't include the browser engine
          fpm -s dir -t freebsd \
            -n vacuumtube \
            -v ${{ github.event.release.tag_name || '1.0.0' }} \
            -C fakedest \
            --depends electron30 \
            --description "VacuumTube YouTube Leanback Client (Native FreeBSD)" \
            --prefix / \
            -p output/vacuumtube-native-freebsd.pkg

      - name: Upload Artifacts to Actions
        uses: actions/upload-artifact@v4
        with:
          name: vacuumtube-freebsd-native
          path: output/

      - name: Upload to Release
        if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/')
        run: |
          TAG=${{ github.event.release.tag_name || github.ref_name }}
          # Upload the native package and the raw asar for flexibility
          gh release upload "$TAG" output/vacuumtube-native-freebsd.pkg --clobber
          gh release upload "$TAG" fakedest/usr/local/share/vacuumtube/app.asar --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
