name: Build FreeBSD Release

permissions:
  contents: write
  packages: write

on:
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-freebsd:
    runs-on: ubuntu-latest
    name: Build for FreeBSD
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
  
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install FPM (Required for FreeBSD packaging)
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential
          sudo gem install fpm

      - name: Build FreeBSD Package
        # This creates the FreeBSD .pkg or .sh installer
        run: npx electron-builder --linux freebsd --x64
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract ASAR for Native Use
        # This provides a fallback for native FreeBSD users
        run: |
          mkdir -p dist/native
          cp dist/linux-unpacked/resources/app.asar dist/native/vacuumtube.asar

      - name: Upload FreeBSD artifacts
        run: |
          # Upload the installer package
          gh release upload ${{ github.event.release.tag_name }} dist/*.pkg --clobber || true
          gh release upload ${{ github.event.release.tag_name }} dist/*.sh --clobber || true
          # Upload the raw ASAR for native FreeBSD Electron execution
          gh release upload ${{ github.event.release.tag_name }} dist/native/vacuumtube.asar --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
